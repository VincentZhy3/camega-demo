<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - Camega</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/png" href="assets/favicon/favicon-96x96.png" sizes="96x96" />
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <!-- Firebase Configuration -->
    <script src="config.js"></script>

    

</head>
<body>
    <header>
        <h1><a href="index.html"><img src="assets/logo.jpg" alt="Camega Logo"></a></h1>
        <button class="nav-toggle" onclick="toggleNav()">â˜°</button>
        <nav id="main-nav">
            <a href="index.html#products">Products</a>
            <a href="index.html#contact">Contact</a>
            <a href="articles.html">Articles</a>
            <a href="user-management.html" class="active">User Center</a>
        </nav>
    </header>

    <!-- Login/Register Interface -->
    <div id="auth-container" class="auth-container">
        <div class="auth-tabs">
            <div class="auth-tab active" onclick="switchTab('login')">Login</div>
            <div class="auth-tab" onclick="switchTab('register')">Register</div>
        </div>

        <!-- Login Form -->
        <form id="login-form" class="auth-form active" onsubmit="handleLogin(event)">
            <input type="email" id="login-email" placeholder="Email Address" required>
            <input type="password" id="login-password" placeholder="Password" required>
            <button type="submit" id="login-btn">Login</button>
            <div id="login-message"></div>
        </form>

        <!-- Register Form -->
        <form id="register-form" class="auth-form" onsubmit="handleRegister(event)">
            <input type="text" id="register-name" placeholder="Full Name" required>
            <input type="email" id="register-email" placeholder="Email Address" required>
            <input type="password" id="register-password" placeholder="Password" required>
            <input type="password" id="register-confirm-password" placeholder="Confirm Password" required>
            <button type="submit" id="register-btn">Register</button>
            <div id="register-message"></div>
        </form>

        <!-- Social Login -->
        <div class="social-login">
            <p>Or continue with:</p>
            <button class="social-btn" onclick="signInWithGoogle()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" width="20" height="20">
                Continue with Google
            </button>
        </div>
    </div>

    <!-- User Dashboard -->
    <div id="user-dashboard" class="user-dashboard hidden">
        <div class="user-info">
            <div class="user-avatar" id="user-avatar">U</div>
            <div class="user-details">
                <h3 id="user-name">User Name</h3>
                <p id="user-email">user@example.com</p>
            </div>
            <button class="logout-btn" onclick="handleLogout()">Logout</button>
        </div>

        <div class="dashboard-grid">
            <div class="dashboard-card" onclick="showOrders()">
                <h4>My Orders</h4>
                <p>View your order history and track shipments</p>
            </div>
            <div class="dashboard-card" onclick="showProfile()">
                <h4>Profile Settings</h4>
                <p>Manage your account information and preferences</p>
            </div>
            <div class="dashboard-card" onclick="showFavorites()">
                <h4>Saved Articles</h4>
                <p>Your favorite health and wellness articles</p>
            </div>
            <div class="dashboard-card" onclick="showSupport()">
                <h4>Customer Support</h4>
                <p>Get help and contact our support team</p>
            </div>
        </div>
    </div>

    <script src="js/user-auth.js"></script>
    <script>
        // Use the global user authentication system
        let currentUser = null;
        
        // Check if user is already logged in when page loads
        window.addEventListener('load', function() {
            // Check Firebase auth state first
            if (typeof firebase !== 'undefined' && firebase.auth) {
                firebase.auth().onAuthStateChanged((user) => {
                    if (user) {
                        // User is signed in with Firebase
                        const userInfo = {
                            name: user.displayName || user.email.split('@')[0],
                            email: user.email,
                            uid: user.uid
                        };
                        localStorage.setItem('currentUser', JSON.stringify(userInfo));
                        currentUser = userInfo;
                        showUserDashboard();
                    } else {
                        // Check localStorage as fallback
                        const user = JSON.parse(localStorage.getItem('currentUser') || 'null');
                        if (user) {
                            currentUser = user;
                            showUserDashboard();
                        }
                    }
                });
            } else {
                // Fallback to localStorage only
                const user = JSON.parse(localStorage.getItem('currentUser') || 'null');
                if (user) {
                    currentUser = user;
                    showUserDashboard();
                }
            }
        });

        function switchTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            
            if (tab === 'login') {
                document.querySelector('.auth-tab:first-child').classList.add('active');
                document.getElementById('login-form').classList.add('active');
            } else {
                document.querySelector('.auth-tab:last-child').classList.add('active');
                document.getElementById('register-form').classList.add('active');
            }
        }

        function showMessage(formId, message, isError = false) {
            const messageDiv = document.getElementById(formId + '-message');
            messageDiv.innerHTML = `<div class="${isError ? 'error-message' : 'success-message'}">${message}</div>`;
        }

        function setLoading(buttonId, isLoading) {
            const button = document.getElementById(buttonId);
            if (isLoading) {
                button.innerHTML = '<span class="loading"></span> Loading...';
                button.disabled = true;
            } else {
                if (buttonId === 'login-btn') {
                    button.textContent = 'Login';
                } else if (buttonId === 'register-btn') {
                    button.textContent = 'Register';
                }
                button.disabled = false;
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                showMessage('login', 'Please fill in all fields', true);
                return;
            }

            setLoading('login-btn', true);

            try {
                const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                
                // Save user info to localStorage
                const userInfo = {
                    name: currentUser.displayName || currentUser.email.split('@')[0],
                    email: currentUser.email,
                    uid: currentUser.uid
                };
                localStorage.setItem('currentUser', JSON.stringify(userInfo));
                
                showUserDashboard();
                showMessage('login', 'Login successful!');
            } catch (error) {
                console.error('Login error:', error);
                let errorMessage = 'Login failed. Please try again.';
                
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage = 'No account found with this email address.';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'Incorrect password.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Invalid email address.';
                        break;
                }
                
                showMessage('login', errorMessage, true);
            } finally {
                setLoading('login-btn', false);
            }
        }

        async function handleRegister(event) {
            event.preventDefault();
            
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;

            if (password !== confirmPassword) {
                showMessage('register', 'Passwords do not match', true);
                return;
            }

            if (!name || !email || !password) {
                showMessage('register', 'Please fill in all fields', true);
                return;
            }

            setLoading('register-btn', true);

            try {
                const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                await userCredential.user.updateProfile({
                    displayName: name
                });
                
                currentUser = userCredential.user;
                
                // Save user info to localStorage
                const userInfo = {
                    name: currentUser.displayName || currentUser.email.split('@')[0],
                    email: currentUser.email,
                    uid: currentUser.uid
                };
                localStorage.setItem('currentUser', JSON.stringify(userInfo));
                
                showUserDashboard();
                showMessage('register', 'Registration successful!');
            } catch (error) {
                console.error('Registration error:', error);
                let errorMessage = 'Registration failed. Please try again.';
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'An account with this email already exists.';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'Password should be at least 6 characters.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Invalid email address.';
                        break;
                }
                
                showMessage('register', errorMessage, true);
            } finally {
                setLoading('register-btn', false);
            }
        }

        async function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                const result = await firebase.auth().signInWithPopup(provider);
                currentUser = result.user;
                
                // Save user info to localStorage
                const userInfo = {
                    name: currentUser.displayName || currentUser.email.split('@')[0],
                    email: currentUser.email,
                    uid: currentUser.uid
                };
                localStorage.setItem('currentUser', JSON.stringify(userInfo));
                
                showUserDashboard();
                showMessage('login', 'Login successful!');
            } catch (error) {
                console.error('Google sign-in error:', error);
                showMessage('login', 'Google sign-in failed. Please try again.', true);
            }
        }

        async function handleLogout() {
            try {
                // Clear localStorage first
                localStorage.removeItem('currentUser');
                localStorage.removeItem('authToken');
                
                // Sign out from Firebase
                await firebase.auth().signOut();
                currentUser = null;
                
                // Show auth container
                showAuthContainer();
                
                // Force reload after a short delay to ensure clean state
                setTimeout(() => {
                    window.location.reload();
                }, 100);
            } catch (error) {
                console.error('Logout error:', error);
                // Fallback: just clear localStorage and reload
                localStorage.removeItem('currentUser');
                localStorage.removeItem('authToken');
                showAuthContainer();
                setTimeout(() => {
                    window.location.reload();
                }, 100);
            }
        }

        function showUserDashboard() {
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('user-dashboard').classList.remove('hidden');
            
            if (currentUser) {
                const displayName = currentUser.displayName || currentUser.email.split('@')[0];
                const email = currentUser.email;
                const avatar = displayName.charAt(0).toUpperCase();
                
                document.getElementById('user-name').textContent = displayName;
                document.getElementById('user-email').textContent = email;
                document.getElementById('user-avatar').textContent = avatar;
                
                // Save user info to localStorage for other pages
                const userInfo = {
                    name: displayName,
                    email: email,
                    uid: currentUser.uid
                };
                localStorage.setItem('currentUser', JSON.stringify(userInfo));
            }
        }

        function showAuthContainer() {
            document.getElementById('auth-container').classList.remove('hidden');
            document.getElementById('user-dashboard').classList.add('hidden');
        }

        function toggleNav() {
            const nav = document.getElementById('main-nav');
            nav.classList.toggle('show');
        }

        // Dashboard functions
        function showOrders() {
            alert('Orders feature coming soon!');
        }

        function showProfile() {
            alert('Profile settings coming soon!');
        }

        function showFavorites() {
            alert('Saved articles feature coming soon!');
        }

        function showSupport() {
            window.location.href = 'index.html#contact';
        }

        // Auth state observer
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                showUserDashboard();
            } else {
                currentUser = null;
                showAuthContainer();
            }
        });

        // Page load
        window.onload = function() {
            // Auth state will be handled by onAuthStateChanged
        };
    </script>
</body>
</html> 